# AIテストパートナー セキュリティ仕様書

**作成日**: 2025年10月2日  
**バージョン**: v1.0

## 1. セキュリティ方針

### 1.1 基本原則

- **Security by Design**: セキュリティを後から追加するのではなく、設計段階から組み込む
- **最小権限の原則**: 必要最小限の権限のみを付与
- **多層防御**: 複数のセキュリティ対策を組み合わせて防御を強化
- **透明性**: ユーザーに対してデータの取り扱いを明確に説明

### 1.2 セキュリティ目標

- ユーザーデータの機密性を保護する
- システムの可用性を維持する
- データの整合性を保証する
- プライバシーを尊重する

## 2. 認証・認可

### 2.1 認証方式

#### 2.1.1 OAuth 2.0認証

- **プロバイダー**: Google、GitHub
- **フロー**: Authorization Code Flow with PKCE
- **トークン**: JWT (JSON Web Token)
- **有効期限**: アクセストークン 1時間、リフレッシュトークン 30日

#### 2.1.2 トークン管理

```typescript
// JWTペイロード例
{
  "sub": "user_id",
  "iss": "test-partner.com",
  "aud": "test-partner-api",
  "exp": 1609459200,
  "iat": 1609455600,
  "scope": "read write"
}
```

#### 2.1.3 セッション管理

- **セッションタイムアウト**: 24時間（非アクティブ時）
- **同時セッション数**: 最大5セッション
- **セッション固定攻撃対策**: セッションIDの再生成

### 2.2 認可制御

#### 2.2.1 リソースベースアクセス制御（RBAC）

```typescript
// 権限定義
enum Permission {
  SESSION_READ = 'session:read',
  SESSION_WRITE = 'session:write',
  SESSION_DELETE = 'session:delete',
  EVENT_READ = 'event:read',
  EVENT_WRITE = 'event:write',
  SCREENSHOT_READ = 'screenshot:read',
  SCREENSHOT_WRITE = 'screenshot:write',
}

// ロール定義
enum Role {
  USER = 'user',
  ADMIN = 'admin',
}
```

#### 2.2.2 データアクセス制御

- **ユーザー分離**: ユーザーは自分のデータのみアクセス可能
- **セッション分離**: セッションは作成者のみアクセス可能
- **API認可**: 全APIエンドポイントで認証・認可を実施

## 3. データ保護

### 3.1 データ分類

#### 3.1.1 機密レベル

- **レベル1（公開）**: 公開API情報
- **レベル2（内部）**: システム内部情報
- **レベル3（機密）**: ユーザー個人情報
- **レベル4（極秘）**: 認証情報、暗号化キー

#### 3.1.2 データマッピング

| データ種別         | 機密レベル | 暗号化       | 保存期間           |
| ------------------ | ---------- | ------------ | ------------------ |
| ユーザー基本情報   | レベル3    | AES-256      | アカウント削除まで |
| テストセッション   | レベル3    | AES-256      | 30日間             |
| イベントログ       | レベル3    | AES-256      | 30日間             |
| スクリーンショット | レベル3    | 保存時暗号化 | 30日間             |
| 認証トークン       | レベル4    | ハッシュ化   | 30日間             |

### 3.2 暗号化

#### 3.2.1 保存時暗号化（Encryption at Rest）

```typescript
// データベース暗号化設定
const encryptionConfig = {
  algorithm: 'aes-256-gcm',
  keyDerivation: 'pbkdf2',
  iterations: 100000,
  keyLength: 32,
  ivLength: 16,
};

// 暗号化実装例
class DataEncryption {
  private key: Buffer;

  constructor(masterKey: string) {
    this.key = crypto.pbkdf2Sync(masterKey, 'salt', 100000, 32, 'sha256');
  }

  encrypt(data: string): string {
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher('aes-256-gcm', this.key);
    cipher.setAAD(Buffer.from('test-partner', 'utf8'));

    let encrypted = cipher.update(data, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    const authTag = cipher.getAuthTag();
    return iv.toString('hex') + ':' + authTag.toString('hex') + ':' + encrypted;
  }
}
```

#### 3.2.2 通信時暗号化（Encryption in Transit）

- **プロトコル**: TLS 1.3以上
- **証明書**: Let's Encrypt（自動更新）
- **HSTS**: 有効化
- **Perfect Forward Secrecy**: 有効化

#### 3.2.3 キー管理

- **マスターキー**: AWS KMSまたはGoogle Cloud KMS
- **キーローテーション**: 90日ごと
- **キー分離**: 環境別（開発、ステージング、本番）

### 3.3 データマスキング

#### 3.3.1 機密情報の自動検出

```typescript
// 機密情報パターン
const sensitivePatterns = [
  /password/i,
  /passwd/i,
  /pwd/i,
  /secret/i,
  /token/i,
  /key/i,
  /credit.*card/i,
  /ssn/i,
  /social.*security/i,
];

// データマスキング実装
class DataMasking {
  static maskSensitiveData(data: any): any {
    if (typeof data === 'string') {
      return this.maskString(data);
    }
    if (typeof data === 'object' && data !== null) {
      return this.maskObject(data);
    }
    return data;
  }

  private static maskString(str: string): string {
    for (const pattern of sensitivePatterns) {
      if (pattern.test(str)) {
        return '[MASKED]';
      }
    }
    return str;
  }
}
```

#### 3.3.2 ユーザー制御マスキング

- **要素選択**: ユーザーが記録しない要素を指定可能
- **フィールドマスキング**: 特定の入力フィールドをマスキング
- **ドメイン除外**: 特定のドメインを記録対象から除外

## 4. ネットワークセキュリティ

### 4.1 通信セキュリティ

#### 4.1.1 HTTPS設定

```nginx
# Nginx設定例
server {
    listen 443 ssl http2;
    server_name api.test-partner.com;

    # SSL証明書
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/private.key;

    # セキュリティヘッダー
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # 暗号化設定
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;
}
```

#### 4.1.2 CORS設定

```typescript
// CORS設定
const corsOptions = {
  origin: ['https://test-partner.com', 'https://app.test-partner.com'],
  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE'],
  allowedHeaders: ['Content-Type', 'Authorization'],
  credentials: true,
  maxAge: 86400,
};
```

### 4.2 ファイアウォール設定

#### 4.2.1 インバウンドルール

- **HTTP/HTTPS**: 80, 443ポートのみ開放
- **SSH**: 管理用IPからのみアクセス可能
- **データベース**: アプリケーションサーバーからのみアクセス可能

#### 4.2.2 アウトバウンドルール

- **外部API**: 必要なエンドポイントのみ許可
- **DNS**: 内部DNSサーバー経由のみ
- **ログ送信**: セキュリティログサーバーへのみ

## 5. アプリケーションセキュリティ

### 5.1 入力値検証

#### 5.1.1 バリデーションスキーマ

```typescript
// Joiスキーマ例
const eventSchema = Joi.object({
  timestamp: Joi.date().iso().required(),
  type: Joi.string().valid('click', 'input', 'screenshot', 'network_error', 'flag').required(),
  payload: Joi.object().required(),
}).strict();

const sessionSchema = Joi.object({
  target_url: Joi.string().uri().required(),
  session_name: Joi.string()
    .max(255)
    .pattern(/^[a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\s]+$/)
    .optional(),
}).strict();
```

#### 5.1.2 SQLインジェクション対策

- **パラメータ化クエリ**: 全クエリでパラメータ化クエリを使用
- **ORM使用**: Prisma ORMによる型安全なクエリ
- **入力サニタイゼーション**: 特殊文字のエスケープ

#### 5.1.3 XSS対策

```typescript
// XSS対策実装
import DOMPurify from 'dompurify';

class XSSProtection {
  static sanitizeHtml(html: string): string {
    return DOMPurify.sanitize(html, {
      ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a'],
      ALLOWED_ATTR: ['href', 'title'],
    });
  }

  static sanitizeText(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#x27;');
  }
}
```

### 5.2 セッション管理

#### 5.2.1 セッション固定攻撃対策

```typescript
// セッションID再生成
app.post('/login', (req, res) => {
  // 認証成功後
  req.session.regenerate(err => {
    if (err) {
      return res.status(500).json({ error: 'Session regeneration failed' });
    }
    // セッション情報を設定
    req.session.userId = user.id;
    res.json({ success: true });
  });
});
```

#### 5.2.2 CSRF対策

```typescript
// CSRFトークン生成・検証
import csrf from 'csurf';

const csrfProtection = csrf({
  cookie: {
    httpOnly: true,
    secure: true,
    sameSite: 'strict',
  },
});

app.use(csrfProtection);
```

### 5.3 レート制限

#### 5.3.1 APIレート制限

```typescript
import rateLimit from 'express-rate-limit';

// 認証API用レート制限
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分
  max: 5, // 最大5回
  message: '認証試行回数が上限に達しました',
  standardHeaders: true,
  legacyHeaders: false,
});

// イベント送信用レート制限
const eventLimiter = rateLimit({
  windowMs: 60 * 1000, // 1分
  max: 100, // 最大100回
  message: 'リクエスト数が上限に達しました',
});
```

## 6. ログ・監視

### 6.1 セキュリティログ

#### 6.1.1 ログ種別

- **認証ログ**: ログイン、ログアウト、認証失敗
- **アクセスログ**: APIアクセス、リソースアクセス
- **エラーログ**: システムエラー、例外
- **セキュリティイベント**: 不正アクセス試行、異常な動作

#### 6.1.2 ログ形式

```json
{
  "timestamp": "2025-10-02T14:30:00Z",
  "level": "INFO",
  "service": "auth-service",
  "event_type": "login_success",
  "user_id": "550e8400-e29b-41d4-a716-446655440001",
  "ip_address": "192.168.1.100",
  "user_agent": "Mozilla/5.0...",
  "session_id": "sess_550e8400-e29b-41d4-a716-446655440000",
  "request_id": "req_550e8400-e29b-41d4-a716-446655440000"
}
```

### 6.2 監視・アラート

#### 6.2.1 監視項目

- **認証失敗**: 5分間に10回以上
- **異常なAPIアクセス**: 1時間に1000回以上
- **データベース接続エラー**: 1分間に5回以上
- **ディスク使用量**: 80%以上

#### 6.2.2 アラート設定

```yaml
# Prometheus Alert Rules
groups:
  - name: security
    rules:
      - alert: HighAuthFailureRate
        expr: rate(auth_failures_total[5m]) > 0.1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: 'High authentication failure rate'

      - alert: SuspiciousAPIUsage
        expr: rate(api_requests_total[1h]) > 1000
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: 'Suspicious API usage detected'
```

## 7. インシデント対応

### 7.1 インシデント分類

#### 7.1.1 重要度レベル

- **レベル1（緊急）**: データ漏洩、システム停止
- **レベル2（高）**: 不正アクセス、サービス障害
- **レベル3（中）**: セキュリティ警告、パフォーマンス問題
- **レベル4（低）**: 情報提供、軽微な問題

#### 7.1.2 対応時間

- **レベル1**: 1時間以内
- **レベル2**: 4時間以内
- **レベル3**: 24時間以内
- **レベル4**: 72時間以内

### 7.2 対応手順

#### 7.2.1 データ漏洩対応

1. **即座の対応**:
   - 影響範囲の特定
   - 漏洩経路の遮断
   - 関係者への通知

2. **調査・分析**:
   - ログの詳細分析
   - 影響範囲の確定
   - 原因の特定

3. **復旧・対策**:
   - 脆弱性の修正
   - セキュリティ強化
   - 再発防止策の実施

#### 7.2.2 不正アクセス対応

1. **即座の対応**:
   - アカウントの無効化
   - セッションの強制終了
   - アクセスの遮断

2. **調査・分析**:
   - アクセスログの分析
   - 影響範囲の特定
   - 攻撃手法の分析

3. **復旧・対策**:
   - セキュリティパッチの適用
   - アクセス制御の強化
   - 監視の強化

## 8. コンプライアンス

### 8.1 法的要件

#### 8.1.1 個人情報保護法

- **個人情報の定義**: ユーザーの氏名、メールアドレス等
- **取得・利用**: 明示的な同意の取得
- **保存・管理**: 適切な保存期間の設定
- **開示・訂正**: ユーザーからの請求への対応

#### 8.1.2 プライバシーポリシー

```markdown
# プライバシーポリシー

## 収集する情報

- ユーザー基本情報（氏名、メールアドレス）
- テストセッション情報（URL、操作ログ）
- 技術情報（ブラウザ情報、IPアドレス）

## 利用目的

- サービスの提供・改善
- セキュリティの維持
- 法的要件への対応

## 第三者提供

- 法令に基づく場合を除き、第三者に提供しません
- データの匿名化後、統計情報として利用する場合があります
```

### 8.2 セキュリティ監査

#### 8.2.1 内部監査

- **頻度**: 四半期ごと
- **対象**: セキュリティポリシーの遵守状況
- **実施者**: 内部セキュリティチーム

#### 8.2.2 外部監査

- **頻度**: 年1回
- **対象**: セキュリティ体制全体
- **実施者**: 外部セキュリティ専門機関

## 9. セキュリティ教育

### 9.1 開発者教育

- **セキュアコーディング**: 月1回の研修
- **脆弱性情報**: 週1回の情報共有
- **インシデント事例**: 四半期ごとの学習会

### 9.2 ユーザー教育

- **セキュリティガイド**: 初回ログイン時の表示
- **ベストプラクティス**: ヘルプページでの提供
- **セキュリティ通知**: 重要な変更時の通知

## 10. 継続的改善

### 10.1 セキュリティ評価

- **脆弱性スキャン**: 月1回の自動スキャン
- **ペネトレーションテスト**: 年2回の実施
- **コードレビュー**: 全コードのセキュリティレビュー

### 10.2 アップデート・パッチ

- **セキュリティパッチ**: 緊急時は24時間以内
- **定期アップデート**: 月1回の定期更新
- **脆弱性対応**: 発見後72時間以内の対応
