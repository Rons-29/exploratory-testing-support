# AIテストパートナー 技術仕様書

**作成日**: 2025年10月2日  
**バージョン**: v1.0

## 1. システムアーキテクチャ

### 1.1 全体構成

```
┌─────────────────┐    HTTPS     ┌─────────────────┐    ┌─────────────────┐
│  Chrome拡張機能  │◄────────────►│  バックエンド    │◄──►│   データベース   │
│  (フロントエンド)│              │   (API Server)  │    │  (PostgreSQL)   │
└─────────────────┘              └─────────────────┘    └─────────────────┘
         │                                │
         │                                │
         ▼                                ▼
┌─────────────────┐              ┌─────────────────┐
│  DevTools API   │              │  AI Services    │
│  (CDP)          │              │  (Future)       │
└─────────────────┘              └─────────────────┘
```

### 1.2 コンポーネント説明

#### 1.2.1 Chrome拡張機能（フロントエンド）

- **役割**: ユーザーインターフェースとデータ収集
- **技術**: TypeScript + React + Vite
- **主要機能**:
  - ユーザー操作の記録
  - DevTools API (CDP) を利用したログ取得
  - UI表示と操作

#### 1.2.2 バックエンド（API Server）

- **役割**: データ処理と保存、AI機能の提供
- **技術**: TypeScript + Node.js + Express
- **主要機能**:
  - API提供
  - データ検証と保存
  - 認証・認可処理
  - 将来的なAI機能

#### 1.2.3 データベース

- **役割**: データの永続化
- **技術**: PostgreSQL
- **主要機能**:
  - ユーザー情報の保存
  - テストセッションの管理
  - イベントログの保存

## 2. 技術スタック

### 2.1 フロントエンド技術

#### 2.1.1 基本技術

- **言語**: TypeScript 5.0+
- **フレームワーク**: React 18+
- **ビルドツール**: Vite 5.0+
- **パッケージマネージャー**: npm 9.0+

#### 2.1.2 UI/UXライブラリ

- **コンポーネント**: Material-UI (MUI) 5.0+
- **アイコン**: Material Icons
- **アニメーション**: Framer Motion
- **日付処理**: date-fns

#### 2.1.3 Chrome拡張機能関連

- **Manifest**: Manifest V3
- **API**: Chrome Extensions API
- **DevTools**: Chrome DevTools Protocol (CDP)

### 2.2 バックエンド技術

#### 2.2.1 基本技術

- **言語**: TypeScript 5.0+
- **ランタイム**: Node.js 18+
- **フレームワーク**: Express 4.18+
- **パッケージマネージャー**: npm 9.0+

#### 2.2.2 データベース関連

- **データベース**: PostgreSQL 14+
- **ORM**: Prisma 5.0+
- **マイグレーション**: Prisma Migrate
- **接続プール**: pg-pool

#### 2.2.3 認証・セキュリティ

- **認証**: Passport.js + OAuth 2.0
- **JWT**: jsonwebtoken
- **暗号化**: bcryptjs
- **バリデーション**: Joi

### 2.3 インフラ・デプロイ

#### 2.3.1 クラウドプラットフォーム

- **プラットフォーム**: Google Cloud Platform
- **コンテナ**: Cloud Run
- **データベース**: Cloud SQL (PostgreSQL)
- **ストレージ**: Cloud Storage

#### 2.3.2 CI/CD

- **バージョン管理**: Git + GitHub
- **CI/CD**: GitHub Actions
- **コンテナ**: Docker
- **レジストリ**: Google Container Registry

## 3. データベース設計

### 3.1 テーブル構成

#### 3.1.1 users テーブル

```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    provider VARCHAR(50) NOT NULL, -- 'google' or 'github'
    provider_id VARCHAR(255) NOT NULL,
    avatar_url TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3.1.2 test_sessions テーブル

```sql
CREATE TABLE test_sessions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    target_url TEXT NOT NULL,
    session_name VARCHAR(255),
    status VARCHAR(20) NOT NULL DEFAULT 'active', -- 'active', 'paused', 'completed'
    start_time TIMESTAMP WITH TIME ZONE NOT NULL,
    end_time TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3.1.3 events テーブル

```sql
CREATE TABLE events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES test_sessions(id) ON DELETE CASCADE,
    timestamp TIMESTAMP WITH TIME ZONE NOT NULL,
    type VARCHAR(50) NOT NULL, -- 'click', 'input', 'screenshot', 'network_error', 'flag', etc.
    payload JSONB NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 3.1.4 screenshots テーブル

```sql
CREATE TABLE screenshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    session_id UUID NOT NULL REFERENCES test_sessions(id) ON DELETE CASCADE,
    event_id UUID REFERENCES events(id) ON DELETE CASCADE,
    file_path TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    mime_type VARCHAR(100) NOT NULL,
    width INTEGER NOT NULL,
    height INTEGER NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 3.2 インデックス設計

```sql
-- パフォーマンス向上のためのインデックス
CREATE INDEX idx_events_session_id_timestamp ON events(session_id, timestamp);
CREATE INDEX idx_events_type ON events(type);
CREATE INDEX idx_test_sessions_user_id ON test_sessions(user_id);
CREATE INDEX idx_test_sessions_status ON test_sessions(status);
CREATE INDEX idx_screenshots_session_id ON screenshots(session_id);
```

## 4. API設計

### 4.1 認証API

#### 4.1.1 Google OAuth認証

```typescript
// 認証フロー
GET / auth / google;
// コールバック
GET / auth / google / callback;
// トークン取得
POST / auth / token;
```

### 4.2 セッション管理API

#### 4.2.1 セッション作成

```typescript
POST /api/sessions
{
  "targetUrl": "https://example.com",
  "sessionName": "ログイン機能テスト"
}

Response:
{
  "id": "uuid",
  "status": "active",
  "startTime": "2025-10-02T14:30:00Z"
}
```

#### 4.2.2 セッション更新

```typescript
PATCH /api/sessions/{sessionId}
{
  "status": "completed", // 'active', 'paused', 'completed'
  "endTime": "2025-10-02T15:30:00Z"
}
```

### 4.3 イベント管理API

#### 4.3.1 イベント送信（バッチ処理）

```typescript
POST /api/sessions/{sessionId}/events
{
  "events": [
    {
      "timestamp": "2025-10-02T14:30:15Z",
      "type": "click",
      "payload": {
        "element": "button#login",
        "x": 100,
        "y": 200
      }
    },
    {
      "timestamp": "2025-10-02T14:30:16Z",
      "type": "console_error",
      "payload": {
        "message": "ReferenceError: undefined is not defined",
        "level": "error",
        "source": "app.js:123"
      }
    }
  ]
}
```

#### 4.3.2 イベント取得（ページネーション）

```typescript
GET /api/sessions/{sessionId}/events?page=1&limit=100&type=click

Response:
{
  "events": [...],
  "pagination": {
    "page": 1,
    "limit": 100,
    "total": 500,
    "hasNext": true
  }
}
```

### 4.4 スクリーンショットAPI

#### 4.4.1 アップロード

```typescript
POST /api/sessions/{sessionId}/screenshots
Content-Type: multipart/form-data

{
  "file": File,
  "eventId": "uuid" // optional
}

Response:
{
  "id": "uuid",
  "url": "https://storage.googleapis.com/bucket/screenshot.jpg"
}
```

## 5. Chrome拡張機能実装

### 5.1 Manifest V3設定

```json
{
  "manifest_version": 3,
  "name": "AIテストパートナー",
  "version": "1.0.0",
  "description": "探索的テストを支援するChrome拡張機能",
  "permissions": ["activeTab", "storage", "scripting", "tabs"],
  "host_permissions": ["https://*/*", "http://*/*"],
  "background": {
    "service_worker": "background.js"
  },
  "content_scripts": [
    {
      "matches": ["<all_urls>"],
      "js": ["content.js"],
      "run_at": "document_end"
    }
  ],
  "action": {
    "default_popup": "popup.html",
    "default_title": "AIテストパートナー"
  },
  "web_accessible_resources": [
    {
      "resources": ["floating-buttons.html"],
      "matches": ["<all_urls>"]
    }
  ]
}
```

### 5.2 コンテンツスクリプト実装

```typescript
// content.js
class EventRecorder {
  private events: EventData[] = [];
  private sessionId: string | null = null;

  constructor() {
    this.initializeEventListeners();
  }

  private initializeEventListeners() {
    // クリックイベント
    document.addEventListener('click', e => {
      this.recordEvent('click', {
        element: this.getElementSelector(e.target),
        x: e.clientX,
        y: e.clientY,
      });
    });

    // 入力イベント
    document.addEventListener('input', e => {
      this.recordEvent('input', {
        element: this.getElementSelector(e.target),
        value: (e.target as HTMLInputElement).value,
      });
    });
  }

  private recordEvent(type: string, payload: any) {
    const event: EventData = {
      timestamp: new Date().toISOString(),
      type,
      payload,
    };

    this.events.push(event);
    this.sendEventsToBackground();
  }
}
```

### 5.3 DevTools Protocol連携

```typescript
// background.js
class DevToolsManager {
  private tabId: number | null = null;

  async startRecording(tabId: number) {
    this.tabId = tabId;

    // CDP接続
    const target = await chrome.debugger.attach({ tabId }, '1.3');

    // コンソールログの監視
    chrome.debugger.onEvent.addListener((source, method, params) => {
      if (source.tabId === tabId && method === 'Runtime.consoleAPICalled') {
        this.handleConsoleEvent(params);
      }
    });

    // ネットワークリクエストの監視
    chrome.debugger.sendCommand({ tabId }, 'Network.enable');
  }

  private handleConsoleEvent(params: any) {
    const event = {
      timestamp: new Date().toISOString(),
      type: 'console_log',
      payload: {
        level: params.type,
        message: params.args[0]?.value,
        source: params.stackTrace?.callFrames[0]?.url,
      },
    };

    this.sendToAPI(event);
  }
}
```

## 6. セキュリティ実装

### 6.1 データ暗号化

```typescript
// 暗号化ユーティリティ
import crypto from 'crypto';

class EncryptionService {
  private readonly algorithm = 'aes-256-gcm';
  private readonly keyLength = 32;
  private readonly ivLength = 16;

  encrypt(text: string, key: string): string {
    const iv = crypto.randomBytes(this.ivLength);
    const cipher = crypto.createCipher(this.algorithm, key);
    cipher.setAAD(Buffer.from('test-partner', 'utf8'));

    let encrypted = cipher.update(text, 'utf8', 'hex');
    encrypted += cipher.final('hex');

    const authTag = cipher.getAuthTag();

    return iv.toString('hex') + ':' + authTag.toString('hex') + ':' + encrypted;
  }

  decrypt(encryptedText: string, key: string): string {
    const [ivHex, authTagHex, encrypted] = encryptedText.split(':');

    const iv = Buffer.from(ivHex, 'hex');
    const authTag = Buffer.from(authTagHex, 'hex');

    const decipher = crypto.createDecipher(this.algorithm, key);
    decipher.setAAD(Buffer.from('test-partner', 'utf8'));
    decipher.setAuthTag(authTag);

    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');

    return decrypted;
  }
}
```

### 6.2 入力値検証

```typescript
// バリデーションスキーマ
import Joi from 'joi';

const eventSchema = Joi.object({
  timestamp: Joi.date().iso().required(),
  type: Joi.string().valid('click', 'input', 'screenshot', 'network_error', 'flag').required(),
  payload: Joi.object().required(),
});

const sessionSchema = Joi.object({
  targetUrl: Joi.string().uri().required(),
  sessionName: Joi.string().max(255).optional(),
});
```

## 7. パフォーマンス最適化

### 7.1 バッチ処理

```typescript
// イベントバッチング
class EventBatcher {
  private events: EventData[] = [];
  private batchSize = 20;
  private batchTimeout = 10000; // 10秒

  addEvent(event: EventData) {
    this.events.push(event);

    if (this.events.length >= this.batchSize) {
      this.flush();
    } else {
      this.scheduleFlush();
    }
  }

  private scheduleFlush() {
    setTimeout(() => {
      if (this.events.length > 0) {
        this.flush();
      }
    }, this.batchTimeout);
  }

  private async flush() {
    if (this.events.length === 0) return;

    const eventsToSend = [...this.events];
    this.events = [];

    await this.sendToAPI(eventsToSend);
  }
}
```

### 7.2 メモリ管理

```typescript
// メモリリーク防止
class MemoryManager {
  private maxEventsInMemory = 1000;

  cleanupOldEvents() {
    if (this.events.length > this.maxEventsInMemory) {
      // 古いイベントを削除
      this.events = this.events.slice(-this.maxEventsInMemory);
    }
  }
}
```

## 8. エラーハンドリング

### 8.1 グローバルエラーハンドラー

```typescript
// エラーハンドリング
class ErrorHandler {
  static handle(error: Error, context: string) {
    console.error(`[${context}] ${error.message}`, error);

    // エラーをAPIに送信
    this.reportError(error, context);

    // ユーザーに通知
    this.notifyUser(error);
  }

  private static async reportError(error: Error, context: string) {
    try {
      await fetch('/api/errors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: error.message,
          stack: error.stack,
          context,
          timestamp: new Date().toISOString(),
        }),
      });
    } catch (reportError) {
      console.error('Failed to report error:', reportError);
    }
  }
}
```

## 9. テスト戦略

### 9.1 単体テスト

- **フレームワーク**: Jest + React Testing Library
- **カバレッジ**: 80%以上
- **対象**: ユーティリティ関数、コンポーネント

### 9.2 統合テスト

- **フレームワーク**: Playwright
- **対象**: エンドツーエンドのユーザーフロー

### 9.3 パフォーマンステスト

- **ツール**: Lighthouse CI
- **指標**: Core Web Vitals準拠
